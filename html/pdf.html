<!DOCTYPE html>
<html lang="en">
<!--
Copyright 2020 Emanuele Sorce

This file is part of Sturm Reader and is distributed under the terms of
the GPL. See the file COPYING for full details.
-->
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no">

<style type="text/css">
	#the-canvas {
		border: 1px solid black;
		direction: ltr;
		height: 100%;
		width: 100%;
	}
</style>

<script src=".pdfjs/build/pdf.js"></script>
<script>

var pageNumber = 1
var pageIsRendering = false
var pageNumIsPending = null

var doc = undefined

const moveToPage = num => {
    pageNumber += num;
    queueRenderPage(pageNumber);
}

const renderPage = num => {
	pageIsRendering = true;

    doc.getPage(num).then(function(page) {
		console.log('Page loaded');
        var scale = 1.5;
		var viewport = page.getViewport({ scale: scale, });

		var canvas = document.getElementById('the-canvas');
		var context = canvas.getContext('2d');
		canvas.height = viewport.height;
		canvas.width = viewport.width;

        var renderContext = {
			canvasContext: context,
			viewport: viewport,
		}
		pageNumber = num
		
        page.render(renderContext).promise.then(() => {
			console.log('Page rendered');
            pageIsRendering = false;
            
            if (pageNumIsPending !== null) {
                renderPage(pageNumIsPending);
                pageNumIsPending = null;
            }
            console.log("PageChange");
        });
    });
}

const queueRenderPage = num => {
    if (pageIsRendering) {
        pageNumIsPending = num;
    } else {
        renderPage(num);
    }
};

window.onload = function() {
	
	pdfjsLib.GlobalWorkerOptions.workerSrc = '.pdfjs/build/pdf.worker.js';
	
	pdfjsLib.getDocument("book.pdf").promise.then(pdf => {
		console.log('PDF loaded');
		doc = pdf
		renderPage(pageNumber)
		console.log("Ready")
	});
}

</script>

</head>

<body>
	<canvas id="the-canvas"></canvas>
</body>

</html>
 
