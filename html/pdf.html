<!DOCTYPE html>
<html lang="en">
<!--
Copyright 2020 Emanuele Sorce

This file is part of Sturm Reader and is distributed under the terms of
the GPL. See the file COPYING for full details.
-->
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no">

<script src=".pdfjs/build/pdf.js"></script>
<script>

var pageNumber = 1
var pageIsRendering = false
var pageNumIsPending = null
var page_width = window.innerWidth

var doc = undefined

function slowForeground(){
	document.getElementById("slow-canvas").style.visibility = "visible";
	document.getElementById("fast-canvas").style.visibility = "hidden";
}

function fastForeground(){
	document.getElementById("slow-canvas").style.visibility = "hidden";
	document.getElementById("fast-canvas").style.visibility = "visible";
}

function windowSizeChanged(){
	if(!doc) return;

	var past_width = page_width
	page_width = window.innerWidth
	// trigger a background rendering if resolution increase
	if(window.innerWidth > past_width)
		queueRenderPage(pageNumber)
	else
		console.log('ok')
}

function statusUpdate() {
	console.log("UpdatePage")
}

function moveToPageRelative (num) {
    queueRenderPage(pageNumber + num);
}

function renderPage (num, fast) {

    doc.getPage(num).then(
		function(page) {
		
			var target_width = page_width;
			var original_viewport = page.getViewport({ scale: 1 });
			var scale = target_width / original_viewport.width;
			
			if(fast)
				scale = Math.max(1.5, scale * 0.3)
			else
				scale = Math.min(5, scale)
			
			var viewport = page.getViewport({ scale: scale });

			var canvas = document.getElementById(fast ? 'fast-canvas' : 'slow-canvas');
			var context = canvas.getContext('2d');
			canvas.height = viewport.height;
			canvas.width = viewport.width;

			var renderContext = {
				canvasContext: context,
				viewport: viewport,
				enableWebGL: true
			}
			pageNumber = num

			page.render(renderContext).promise.then(
				function(){
					if(fast) fastForeground()
					else slowForeground()
					console.log("UpdatePage");
					if (pageNumIsPending !== null) {
						var temp_next_page = pageNumIsPending
						pageNumIsPending = null;
						renderPage(temp_next_page, true);
					}
					else if(fast)
						renderPage(num, false)
				},
				function(reason){
					console.log("# page rendering failed " + reason);
				}
			)
		},
		function(reason){
			console.log("#page loading failed " + reason);
		}
	)
}

function queueRenderPage (num) {
    if (pageIsRendering) {
        pageNumIsPending = num;
    } else {
		pageIsRendering = true;
        renderPage(num, true);
		pageIsRendering = false;
    }
};

window.onload = function() {
	
	pdfjsLib.GlobalWorkerOptions.workerSrc = '.pdfjs/build/pdf.worker.js';
	
	pdfjsLib.getDocument("book.pdf").promise.then(
		function(pdf) {
			doc = pdf
			queueRenderPage(pageNumber)
			console.log("Ready")
		},
		function(reason){
			console.log("#pdf file loading failed " + reason)
		}
	)
}
</script>

<style type="text/css">
	.page {
		margin: 0px
		border: 0px;
		direction: ltr;
		width: 100%;
		position: absolute;
		top: 0px;
		left: 0px;
	}
	body{
		margin: 0px;
	}
</style>

</head>

<body>
	<canvas class="page" id="fast-canvas"></canvas>
</body>

<body>
	<canvas class="page" id="slow-canvas"></canvas>
</body>

</html>
 
